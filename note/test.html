<!DOCTYPE html><meta charset="utf-8">
<title>note 画像テスト</title>
<div id="out" style="max-width:780px;margin:20px auto;font:16px/1.6 system-ui">
  <h1>note画像テスト（最新1件）</h1>
  <div id="card" style="border:1px solid #ddd;border-radius:12px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.08)"></div>
</div>
<script>
(async () => {
  // --- RSS取得（候補3通り）
  const CANDIDATES = [
    "https://r.jina.ai/http/https://note.com/loyal_dill1011/rss",
    "https://r.jina.ai/http/note.com/loyal_dill1011/rss",
    "https://api.allorigins.win/raw?url="+encodeURIComponent("https://note.com/loyal_dill1011/rss")
  ];
  const fetchAny = async (urls)=>{let e; for(const u of urls){try{const r=await fetch(u); if(!r.ok)throw new Error(r.status); return r.text();}catch(err){e=err}} throw e};
  const xmlText = await fetchAny(CANDIDATES);
  const xml = new DOMParser().parseFromString(xmlText,"text/xml");
  const item = xml.querySelector("item"); if(!item){ card.textContent="itemなし"; return; }

  // --- ユーティリティ
  const abs = u => !u ? "" : u.startsWith("http") ? u : u.startsWith("//") ? "https:"+u : u.startsWith("/") ? "https://note.com"+u : u;
  const decodeHTML = h => new DOMParser().parseFromString(h||"","text/html").documentElement.textContent || "";
  const firstImg = (html) => {
    const doc = new DOMParser().parseFromString(decodeHTML(html),"text/html");
    const img = doc.querySelector("img");
    if(!img) return "";
    const srcset = (img.getAttribute("srcset")||"").split(" ")[0];
    return abs(srcset || img.getAttribute("src") || img.getAttribute("data-src") || img.getAttribute("data-original") || "");
  };
  // 画像用プロキシ（ホットリンク回避）
  const imgProxy = (u) => u ? `https://images.weserv.nl/?url=${encodeURIComponent(u.replace(/^https?:\/\//,''))}&output=jpg` : "";
  const fallback = "https://assets.st-note.com/production/uploads/images/default/ogp.png";

  // --- 画像抽出
  let img = item.querySelector("enclosure")?.getAttribute("url")
         || item.querySelector("media\\:thumbnail")?.getAttribute("url")
         || item.querySelector("media\\:content")?.getAttribute("url") || "";
  if(!img) img = firstImg(item.querySelector("content\\:encoded")?.textContent||"");
  if(!img) img = firstImg(item.querySelector("description")?.textContent||"");
  img = abs(img || fallback);

  const title = item.querySelector("title")?.textContent ?? "";
  const link  = item.querySelector("link")?.textContent ?? "#";

  const card = document.getElementById("card");
  const prox = imgProxy(img);

  console.log("[TEST] raw:", img);
  console.log("[TEST] proxied:", prox);

  card.innerHTML = `
    <a href="${link}" target="_blank" rel="noopener" style="display:block;color:inherit;text-decoration:none">
      <div style="aspect-ratio:16/9;background:#eee">
        <img id="ph" src="${prox}" alt="${title}" loading="eager" style="width:100%;height:100%;object-fit:cover;display:block">
      </div>
      <div style="padding:12px 14px"><strong>${title}</strong><div style="font-size:12px;color:#666">${new Date().toLocaleString()}</div></div>
    </a>
    <pre id="log" style="white-space:pre-wrap;background:#f7f7f7;padding:10px;border:1px solid #eee;margin:8px 0 0;border-radius:8px"></pre>
  `;
  const ph = document.getElementById("ph");
  const log = document.getElementById("log");
  const add = (m) => { console.log(m); log.textContent += m+"\n"; };

  ph.addEventListener("load",  () => add("[IMG] load OK"));
  ph.addEventListener("error", () => {
    add("[IMG] onerror fired → fallbackに切替");
    ph.src = imgProxy(fallback);
  });
})();
</script>
