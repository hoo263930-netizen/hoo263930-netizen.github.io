<script>
(async () => {
  const CANDIDATES = [
    "https://r.jina.ai/http/https://note.com/loyal_dill1011/rss",
    "https://r.jina.ai/http/note.com/loyal_dill1011/rss",
    "https://api.allorigins.win/raw?url="+encodeURIComponent("https://note.com/loyal_dill1011/rss")
  ];
  const fetchAny = async (urls)=>{let e; for(const u of urls){try{const r=await fetch(u); if(!r.ok)throw new Error(r.status); return r.text();}catch(err){e=err}} throw e};

  // ★ 修正版 abs()
  const abs = (u) => {
    if (!u) return "";
    if (/^https?:\/\//i.test(u)) return u;
    if (u.startsWith("//")) return "https:" + u;
    if (u.startsWith("/"))  return "https://note.com" + u;
    return u;
  };

  const decodeHTML = h => new DOMParser().parseFromString(h||"","text/html").documentElement.textContent || "";
  const firstImg = (html) => {
    const doc = new DOMParser().parseFromString(decodeHTML(html),"text/html");
    const img = doc.querySelector("img");
    if(!img) return "";
    const srcset = (img.getAttribute("srcset")||"").split(" ")[0];
    return abs(srcset || img.getAttribute("src") || img.getAttribute("data-src") || img.getAttribute("data-original") || "");
  };

  // 画像用プロキシ（任意。直リンクで出なければ使う）
  const imgProxy = (u) => u ? `https://images.weserv.nl/?url=${encodeURIComponent(u.replace(/^https?:\/\//,''))}&output=jpg` : "";
  const fallback = "https://assets.st-note.com/production/uploads/images/default/ogp.png";

  const xmlText = await fetchAny(CANDIDATES);
  const xml = new DOMParser().parseFromString(xmlText,"text/xml");
  const item = xml.querySelector("item");
  const title = item.querySelector("title")?.textContent ?? "";
  const link  = item.querySelector("link")?.textContent ?? "#";

  let img = item.querySelector("enclosure")?.getAttribute("url")
         || item.querySelector("media\\:thumbnail")?.getAttribute("url")
         || item.querySelector("media\\:content")?.getAttribute("url") || "";
  if(!img) img = firstImg(item.querySelector("content\\:encoded")?.textContent||"");
  if(!img) img = firstImg(item.querySelector("description")?.textContent||"");
  img = abs(img || fallback);

  // 必要に応じてプロキシ
  const imgForTag = imgProxy(img) || img;

  console.log("[TEST] raw:", img);
  console.log("[TEST] proxied:", imgForTag);

  document.getElementById("card").innerHTML = `
    <a href="${link}" target="_blank" rel="noopener" style="display:block;color:inherit;text-decoration:none">
      <div style="aspect-ratio:16/9;background:#eee">
        <img id="ph" src="${imgForTag}" alt="${title}" loading="eager" style="width:100%;height:100%;object-fit:cover;display:block"
             onerror="this.src='https://images.weserv.nl/?url=assets.st-note.com/production/uploads/images/default/ogp.png&output=jpg'">
      </div>
      <div style="padding:12px 14px"><strong>${title}</strong></div>
    </a>`;
})();
</script>
