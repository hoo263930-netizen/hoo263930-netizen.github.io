<section class="note-section">
  <h2 class="note-heading">📝 最新のnote記事</h2>
  <div id="note-grid"></div>
  <div class="note-actions">
    <a class="btn-more" href="https://note.com/loyal_dill1011" target="_blank" rel="noopener">もっと読む</a>
  </div>
</section>

<style>
.note-section{padding:36px 18px;background:#fafaf7}
#note-grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
.note-card{
  background:#fff;border-radius:18px;overflow:hidden;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  transition:transform .2s, box-shadow .2s;
}
.note-card:hover{transform:translateY(-4px);box-shadow:0 10px 24px rgba(0,0,0,.12)}
.note-thumb{
  background:#f2f2f0;display:flex;align-items:center;justify-content:center;
  height:180px;
}
.note-thumb img{width:100%;height:180px;object-fit:cover;display:block;}
.note-thumb.noimg::before{content:"🪷";font-size:40px;opacity:.4}
.note-content{padding:16px 20px;}
.note-title{font-weight:700;margin:0 0 6px;font-size:1.05rem;line-height:1.35}
.note-title a{color:#111;text-decoration:none;}
.note-title a:hover{text-decoration:underline;}
.note-meta{font-size:.86rem;color:#666;margin:0 0 10px;}
.note-desc{color:#444;line-height:1.5;margin:0;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
/* 既読でも紫にならないよう固定 */
.note-content a, .note-content a:visited{color:#111;text-decoration:underline;}
.btn-more{
  display:inline-block;margin-top:20px;padding:10px 18px;border-radius:999px;
  background:#f3b700;color:#111;text-decoration:none;
  box-shadow:0 6px 14px rgba(243,183,0,.35);
}
</style>

<script>
(async () => {
  const mount = document.getElementById("note-grid");
  if (!mount) return;
  mount.innerHTML = '<div class="note-card"><div class="note-content">読み込み中…</div></div>';

  const toAbs = (u, base) => { try { return new URL(u, base).href; } catch { return u || ""; } };
  const strip = (html) => (html || "").replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
  const fmtDate = (s) => {
    const d = new Date(s);
    if (isNaN(d)) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}/${m}/${day}`;
  };
  const text = (el, sel) => el.querySelector(sel)?.textContent || "";
  const attr  = (el, sel, name) => el.querySelector(sel)?.getAttribute(name) || "";

  try {
    // CORS回避 + 1時間キャッシュ
    const rssURL   = encodeURIComponent("https://note.com/loyal_dill1011/rss");
    const proxyURL = `https://api.allorigins.win/get?url=${rssURL}&cache=3600`;
    const res = await fetch(proxyURL);
    const data = await res.json();
    const xml = new DOMParser().parseFromString(data.contents, "text/xml");
    const items = Array.from(xml.querySelectorAll("item"));
    if (!items.length) {
      mount.innerHTML = "<p style='color:#666'>記事が見つかりませんでした。</p>";
      return;
    }

    const posts = items.slice(0,3).map((item) => {
      const title = text(item, "title");
      const link  = text(item, "link");
      const date  = fmtDate(text(item, "pubDate"));
      const dhtml = text(item, "description");

      // description内の最初の<img>を拾う
      const imgFromDesc = (() => {
        const m = dhtml.match(/<img[^>]+src="([^">]+)"/i);
        return m ? m[1] : "";
      })();

      // media / enclosure の候補も見る
      const imgMedia = attr(item, "media\\:thumbnail", "url") || attr(item, "media\\:content", "url");
      const imgEnc   = attr(item, "enclosure", "url");

      let img = imgMedia || imgEnc || imgFromDesc || "";
      img = toAbs(img, link);

      // 「続きをみる」などを除去して短文に
      const desc = strip(dhtml).replace(/続きをみる.*/g, "").slice(0, 80);

      return { title, link, date, img, desc };
    });

    mount.innerHTML = posts.map(({ title, link, date, img, desc }) => {
      const imgPart = img
        ? `<div class="note-thumb"><img src="${img}" loading="lazy" decoding="async"
             referrerpolicy="no-referrer"
             onerror="this.parentNode.classList.add('noimg'); this.remove();" alt=""></div>`
        : `<div class="note-thumb noimg"></div>`;

      return `
        <article class="note-card">
          ${imgPart}
          <div class="note-content">
            <h3 class="note-title"><a href="${link}" target="_blank" rel="noopener">${title}</a></h3>
            ${date ? `<p class="note-meta">${date}</p>` : ``}
            <p class="note-desc">${desc}</p>
            <a href="${link}" target="_blank" rel="noopener" class="note-more">続きをみる</a>
          </div>
        </article>`;
    }).join("");

    // デバッグ用（必要なときだけON）
    // console.table(posts.map(p => ({ title: p.title, img: p.img })));

  } catch (e) {
    console.error(e);
    mount.innerHTML = "<p style='color:red'>noteの読み込みに失敗しました。</p>";
  }
})();
</script>
