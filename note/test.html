<script>
(async () => {
  const el = document.getElementById("note-grid");
  el.innerHTML = '<div class="note-card"><div class="note-content">読み込み中…</div></div>';

  const pickImgFromHTML = (html) => {
    if (!html) return "";
    const div = document.createElement("div");
    div.innerHTML = html;
    return div.querySelector("img")?.getAttribute("src") || "";
  };

  const toAbs = (u, base) => {
    try { return new URL(u, base).href; } catch { return u || ""; }
  };

  try {
    const res  = await fetch("https://api.rss2json.com/v1/api.json?rss_url=https://note.com/loyal_dill1011/rss");
    const data = await res.json();

    const items = (data.items || []).slice(0, 3).map((item) => {
      // 画像候補（フォールバック）
      const c1 = item.thumbnail;
      const c2 = item.enclosure?.link || item.enclosure?.url || "";
      const c3 = Array.isArray(item.enclosures) && item.enclosures[0]
                 ? (item.enclosures[0].link || item.enclosures[0].url || "")
                 : "";
      const c4 = pickImgFromHTML(item.content);
      const c5 = pickImgFromHTML(item.description);

      let img = c1 || c2 || c3 || c4 || c5 || "";
      img = toAbs(img, item.link); // 念のため絶対URL化

      const desc = (item.description || "")
        .replace(/<[^>]+>/g, "")
        .replace(/\s+/g, " ")
        .slice(0, 80);

      return {
        title: item.title,
        link : item.link,
        date : new Date(item.pubDate).toLocaleDateString("ja-JP"),
        img,
        desc
      };
    });

    // 必要ならデバッグ
    // console.table(items.map(i => ({ title: i.title, img: i.img })));

    el.innerHTML = items.map(({ title, link, date, img, desc }) => {
      const imgPart = img
        ? `<div class="note-thumb">
             <img src="${img}" loading="lazy" decoding="async"
                  referrerpolicy="no-referrer"
                  onerror="this.closest('.note-thumb')?.remove();"
                  alt="">
           </div>`
        : "";

      return `
        <article class="note-card">
          ${imgPart}
          <div class="note-content">
            <h3 class="note-title"><a href="${link}" target="_blank" rel="noopener">${title}</a></h3>
            <p class="note-meta">${date}</p>
            <p class="note-desc">${desc}</p>
          </div>
        </article>`;
    }).join("");

  } catch (e) {
    console.error(e);
    el.innerHTML = "<p style='color:red'>noteの読み込みに失敗しました。</p>";
  }
})();
</script>
