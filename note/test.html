<section class="note-section">
  <h2 class="note-heading">ğŸ“ æœ€æ–°ã®noteè¨˜äº‹</h2>
  <div id="note-grid"></div>
  <div class="note-actions">
    <a class="btn-more" href="https://note.com/loyal_dill1011" target="_blank" rel="noopener">ã‚‚ã£ã¨èª­ã‚€</a>
  </div>
</section>

<style>
.note-section{padding:36px 18px;background:#fafaf7}
#note-grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
.note-card{
  background:#fff;border-radius:18px;overflow:hidden;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  transition:transform .2s, box-shadow .2s;
}
.note-card:hover{transform:translateY(-4px);box-shadow:0 10px 24px rgba(0,0,0,.12)}
.note-thumb{background:#f2f2f0}
.note-thumb img{width:100%;height:180px;object-fit:cover;display:block;}
.note-content{padding:16px 20px;}
.note-title{font-weight:700;margin:0 0 6px;font-size:1.05rem;line-height:1.35}
.note-title a{color:#111;text-decoration:none;}
.note-title a:hover{text-decoration:underline;}
.note-meta{font-size:.86rem;color:#666;margin:0 0 10px;}
.note-desc{color:#444;line-height:1.5;margin:0;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.btn-more{
  display:inline-block;margin-top:20px;padding:10px 18px;border-radius:999px;
  background:#f3b700;color:#111;text-decoration:none;
  box-shadow:0 6px 14px rgba(243,183,0,.35);
}
</style>

<script>
(async () => {
  const mount = document.getElementById("note-grid");
  if (!mount) return;
  mount.innerHTML = '<div class="note-card"><div class="note-content">èª­ã¿è¾¼ã¿ä¸­â€¦</div></div>';

  // ç”»åƒæŠ½å‡ºãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆæœ¬æ–‡HTMLã‹ã‚‰æœ€åˆã®<img src>ï¼‰
  const pickImgFromHTML = (html) => {
    if (!html) return "";
    const div = document.createElement("div");
    div.innerHTML = html;
    return div.querySelector("img")?.getAttribute("src") || "";
  };
  // ç›¸å¯¾â†’çµ¶å¯¾URLï¼ˆå¤±æ•—æ™‚ã¯å…ƒã‚’è¿”ã™ï¼‰
  const toAbs = (u, base) => { try { return new URL(u, base).href; } catch { return u || ""; } };
  // ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢
  const strip = (html) => (html || "").replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();

  try {
    // âœ… rss2json ã®ä»£æ›¿ï¼šCORSå¯¾å¿œ
    const API = "https://feedapi.vercel.app/api?url=https://note.com/loyal_dill1011/rss";
    const res = await fetch(API);
    const data = await res.json();

    // å¿œç­”ã®å½¢ãŒ [items] ã‹ [entries] ã‹ã‚’å¸å
    const rawItems = Array.isArray(data?.items) ? data.items
                    : Array.isArray(data?.entries) ? data.entries
                    : [];

    if (!rawItems.length) {
      console.warn("Feed response (no items):", data);
      mount.innerHTML = "<p style='color:#666'>è¨˜äº‹ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
      return;
    }

    const items = rawItems.slice(0, 3).map((it) => {
      const title = it.title || "";
      const link  = it.link  || it.url || "#";
      const dateStr = it.pubDate || it.published || it.updated || "";
      const date = dateStr ? new Date(dateStr).toLocaleDateString("ja-JP") : "";

      // æœ¬æ–‡HTMLå€™è£œ
      const html1 = it.content || it["content:encoded"] || "";
      const html2 = it.description || it.summary || "";

      // enclosure / media ã®å€™è£œ
      const enc  = it.enclosure?.url || it.enclosure?.link || "";
      const m1   = it["media:content"]?.url || it["media:thumbnail"]?.url || "";
      const m2   = Array.isArray(it.enclosures) && it.enclosures[0]
                   ? (it.enclosures[0].url || it.enclosures[0].link || "")
                   : "";

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é †
      let img = it.thumbnail || enc || m1 || m2 || pickImgFromHTML(html1) || pickImgFromHTML(html2) || "";
      img = toAbs(img, link);

      const desc = strip(html2 || html1).slice(0, 80);

      return { title, link, date, img, desc };
    });

    // æç”»
    mount.innerHTML = items.map(({ title, link, date, img, desc }) => {
      const imgPart = img ? `
        <div class="note-thumb">
          <img src="${img}" loading="lazy" decoding="async"
               referrerpolicy="no-referrer"
               onerror="this.closest('.note-thumb')?.remove();"
               alt="">
        </div>` : "";
      return `
        <article class="note-card">
          ${imgPart}
          <div class="note-content">
            <h3 class="note-title"><a href="${link}" target="_blank" rel="noopener">${title}</a></h3>
            ${date ? `<p class="note-meta">${date}</p>` : ``}
            <p class="note-desc">${desc}</p>
          </div>
        </article>`;
    }).join("");

    // ãƒ‡ãƒãƒƒã‚°ã—ãŸã„ã¨ãã ã‘ON
    // console.table(items.map(i => ({ title: i.title, img: i.img })));

  } catch (e) {
    console.error(e);
    document.getElementById("note-grid").innerHTML =
      "<p style='color:red'>noteã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
  }
})();
</script>
