<script>
(async () => {
  const RSS = "/note/feed.xml";  // ← ミラー

  const abs = (u)=> {
    if (!u) return "";
    if (/^https?:\/\//i.test(u)) return u;
    if (u.startsWith("//")) return "https:" + u;
    if (u.startsWith("/"))  return "https://note.com" + u;
    return u;
  };
  const decodeHTML = (h)=> new DOMParser().parseFromString(h||"","text/html").documentElement.textContent || "";
  const firstImgFromHTML = (html)=>{
    const doc = new DOMParser().parseFromString(decodeHTML(html), "text/html");
    const img = doc.querySelector("img");
    if (!img) return "";
    const srcset = (img.getAttribute("srcset")||"").split(" ")[0];
    return abs(srcset || img.getAttribute("src") || img.getAttribute("data-src") || img.getAttribute("data-original") || "");
  };
  const imgProxy = (u)=> u ? `https://images.weserv.nl/?url=${encodeURIComponent(u.replace(/^https?:\/\//,''))}&output=jpg` : "";
  const FALLBACK = "https://assets.st-note.com/production/uploads/images/default/ogp.png";

  const res = await fetch(RSS, {cache:"no-store"});
  if (!res.ok) throw new Error("RSS mirror fetch failed: " + res.status);
  const xmlText = await res.text();
  const xml = new DOMParser().parseFromString(xmlText, "text/xml");
  const it  = xml.querySelector("item");
  const title = it.querySelector("title")?.textContent ?? "";
  const link  = it.querySelector("link")?.textContent ?? "#";

  let img = it.querySelector("enclosure")?.getAttribute("url")
          || it.querySelector("media\\:thumbnail")?.getAttribute("url")
          || it.querySelector("media\\:content")?.getAttribute("url") || "";
  if (!img) img = firstImgFromHTML(it.querySelector("content\\:encoded")?.textContent || "");
  if (!img) img = firstImgFromHTML(it.querySelector("description")?.textContent || "");
  img = abs(img || FALLBACK);

  const imgForTag = imgProxy(img) || img;

  document.getElementById("card").innerHTML = `
    <a href="${link}" target="_blank" rel="noopener">
      <div class="ph"><img src="${imgForTag}" alt="${title}" loading="eager"></div>
      <div style="padding:12px 14px"><strong>${title}</strong></div>
    </a>`;
})();
</script>
